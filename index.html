<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#0a0a0a">
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="stylesheet" href="./styles.css">
  <title>ID Search – Wrapper</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body>
  <div class="app">
    <header>
      <div class="badge">PWA Wrapper</div>
      <div class="title">ID Search</div>
      <div class="spacer"></div>
      <button id="installBtn" class="btn hidden">تثبيت</button>
      <button id="editBtn" class="btn">الرابط</button>
    </header>

    <main class="wrap">
      <section id="setup" class="setup hidden">
        <div>
          <h3>أدخل رابط الأداة</h3>
          <p class="note">ضع هنا رابط الويب-أب الحالي (Google Apps Script) أو افتح الصفحة بهذه الصيغة:<br><code>?u=YOUR_URL_ENCODED</code></p>
        </div>
        <input id="urlInput" type="url" placeholder="https://script.google.com/...">
        <div style="display:flex; gap:10px;">
          <button id="saveBtn" class="btn">حفظ</button>
          <button id="cancelBtn" class="btn">إلغاء</button>
        </div>
      </section>
      <iframe id="appFrame" sandbox="allow-scripts allow-forms allow-same-origin allow-popups allow-popups-to-escape-sandbox" referrerpolicy="no-referrer"></iframe>
    </main>

    <footer>ID Search Wrapper • يعمل بدون تعديل أي سطر في مشروعك</footer>
  </div>

  <script>
    const LS_KEY = 'WRAPPED_APP_URL';
    const frame = document.getElementById('appFrame');
    const setup = document.getElementById('setup');
    const input = document.getElementById('urlInput');
    const editBtn = document.getElementById('editBtn');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    let deferredPrompt;

    // Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js');
    }

    // Install prompt
    const installBtn = document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.classList.remove('hidden');
    });
    installBtn?.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      installBtn.classList.add('hidden');
    });

    // Helper to get URL param
    function getParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    function showSetup(show) {
      setup.classList.toggle('hidden', !show);
    }

    function loadApp(url) {
      frame.src = url;
    }

    function resolveUrl() {
      const param = getParam('u');
      if (param) {
        try {
          const decoded = decodeURIComponent(param);
          localStorage.setItem(LS_KEY, decoded);
          return decoded;
        } catch { /* ignore */ }
      }
      const saved = localStorage.getItem(LS_KEY);
      return saved || '';
    }

    // Init
    const startUrl = resolveUrl();
    if (startUrl) {
      loadApp(startUrl);
    } else {
      showSetup(true);
    }

    // Edit flow
    editBtn.addEventListener('click', () => {
      input.value = localStorage.getItem(LS_KEY) || '';
      showSetup(true);
      input.focus();
    });
    saveBtn.addEventListener('click', () => {
      const u = input.value.trim();
      if (!u) return;
      localStorage.setItem(LS_KEY, u);
      showSetup(false);
      loadApp(u);
    });
    cancelBtn.addEventListener('click', () => {
      showSetup(false);
    });
  </script>
</body>
</html>
